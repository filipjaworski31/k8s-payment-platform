name: Docker Build, Scan & Push to ECR

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'payment-api/**'
      - 'payment-worker/**'
      - 'Dockerfile.api'
      - 'Dockerfile.worker'
      - '.github/workflows/docker-build-scan-push.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'payment-api/**'
      - 'payment-worker/**'
      - 'Dockerfile.api'
      - 'Dockerfile.worker'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  PROJECT_NAME: finpay-payment-platform

permissions:
  id-token: write
  contents: read

jobs:
  build-scan-api:
    name: Build & Scan payment-api
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Docker metadata
        id: meta
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="v1.0.${{ github.run_number }}"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            TAG="dev-${{ github.run_number }}"
          else
            TAG="pr-${{ github.event.pull_request.number }}"
          fi
          echo "tags=${TAG}" >> $GITHUB_OUTPUT
          echo "short-sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build-date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build payment-api image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: false
          load: true
          tags: |
            payment-api:${{ steps.meta.outputs.tags }}
            payment-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.created=${{ steps.meta.outputs.build-date }}
            org.opencontainers.image.revision=${{ steps.meta.outputs.short-sha }}
            org.opencontainers.image.version=${{ steps.meta.outputs.tags }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: payment-api:${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-results-api.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Check for CRITICAL vulnerabilities
        run: |
          echo "Checking for CRITICAL vulnerabilities..."
          CRITICAL_COUNT=$(docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity CRITICAL \
            --format json \
            payment-api:${{ steps.meta.outputs.tags }} | \
            jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length')
          echo "CRITICAL vulnerabilities found: $CRITICAL_COUNT"
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "❌ CRITICAL vulnerabilities detected!"
            exit 1
          else
            echo "✅ No CRITICAL vulnerabilities found!"
          fi

      - name: Save image as artifact
        if: github.event_name != 'pull_request'
        run: |
          docker save payment-api:${{ steps.meta.outputs.tags }} | gzip > payment-api-image.tar.gz

      - name: Upload image artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: payment-api-image
          path: payment-api-image.tar.gz
          retention-days: 1

  build-scan-worker:
    name: Build & Scan payment-worker
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Docker metadata
        id: meta
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="v1.0.${{ github.run_number }}"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            TAG="dev-${{ github.run_number }}"
          else
            TAG="pr-${{ github.event.pull_request.number }}"
          fi
          echo "tags=${TAG}" >> $GITHUB_OUTPUT

      - name: Build payment-worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.worker
          push: false
          load: true
          tags: payment-worker:${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Check for CRITICAL vulnerabilities
        run: |
          CRITICAL_COUNT=$(docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity CRITICAL \
            --format json \
            payment-worker:${{ steps.meta.outputs.tags }} | \
            jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length')
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "❌ CRITICAL vulnerabilities detected!"
            exit 1
          fi

      - name: Save image as artifact
        if: github.event_name != 'pull_request'
        run: |
          docker save payment-worker:${{ steps.meta.outputs.tags }} | gzip > payment-worker-image.tar.gz

      - name: Upload image artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: payment-worker-image
          path: payment-worker-image.tar.gz
          retention-days: 1

  push-to-ecr:
    name: Push to AWS ECR
    runs-on: ubuntu-latest
    needs: [build-scan-api, build-scan-worker]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Load Docker images
        run: |
          docker load < payment-api-image/payment-api-image.tar.gz
          docker load < payment-worker-image/payment-worker-image.tar.gz

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Push Images
        run: |
          docker tag payment-api:${{ needs.build-scan-api.outputs.image-tag }} ${ECR_REGISTRY}/${PROJECT_NAME}-payment-api:${{ needs.build-scan-api.outputs.image-tag }}
          docker tag payment-api:${{ needs.build-scan-api.outputs.image-tag }} ${ECR_REGISTRY}/${PROJECT_NAME}-payment-api:latest
          docker push ${ECR_REGISTRY}/${PROJECT_NAME}-payment-api --all-tags

          docker tag payment-worker:${{ needs.build-scan-worker.outputs.image-tag }} ${ECR_REGISTRY}/${PROJECT_NAME}-payment-worker:${{ needs.build-scan-worker.outputs.image-tag }}
          docker tag payment-worker:${{ needs.build-scan-worker.outputs.image-tag }} ${ECR_REGISTRY}/${PROJECT_NAME}-payment-worker:latest
          docker push ${ECR_REGISTRY}/${PROJECT_NAME}-payment-worker --all-tags